# safe API

`safe` wraps any function — sync or async — and returns a `[error, data]` tuple instead of throwing.

```ts
import { safe } from 'data-provider/safe';
```

---

## `safe(fn, errorTypes?, errorTransformer?)`

**Parameters**

| Parameter | Type | Description |
|-----------|------|-------------|
| `fn` | `(...args) => T \| Promise<T>` | Function to wrap — sync or async |
| `errorTypes` | `readonly ErrorConstructor[]` | Optional. Only catch these error types; rethrow others. Use `as const`. |
| `errorTransformer` | `(error: Error) => ErrorType` | Optional. Transform caught errors before returning. |

**Return type**

Returns a wrapped function with the same parameters as `fn`:

- On success: `[null, T]`
- On error: `[ErrorType, null]`

For async functions, the tuple is wrapped in a `Promise`.

---

## Examples

### Basic usage — sync

```ts
const divide = safe((a: number, b: number) => {
  if (b === 0) throw new Error('Division by zero');
  return a / b;
});

const [error, result] = divide(10, 2);  // [null, 5]
const [error2, result2] = divide(10, 0); // [Error('Division by zero'), null]
```

### Basic usage — async

```ts
const fetchUser = safe(async (id: string) => {
  const res = await fetch(`/api/users/${id}`);
  return res.json() as User;
});

const [error, user] = await fetchUser('123');
```

### Narrowing error types

Only catch specific errors. Others are rethrown.

```ts
class ValidationError extends Error {}
class NetworkError extends Error {}

const fetchUser = safe(
  async (id: string) => {
    // ...fetch logic
  },
  [ValidationError, NetworkError] as const // ← as const is required for type narrowing
);

const [error, user] = await fetchUser('123');
// TypeScript knows: error is ValidationError | NetworkError | null
```

### Error transformation

Convert caught errors into a domain-specific type:

```ts
class AppError extends Error {
  constructor(message: string, public code: string) {
    super(message);
  }
}

const processData = safe(
  async (input: unknown) => parse(input),
  [Error] as const,
  (error) => new AppError(error.message, 'PARSE_ERROR')
);

const [error, result] = await processData(rawInput);
// error is AppError | null
```

---

## Notes

- `safe` is used internally by `createSafeProvider`
- Use `as const` on the error types array — without it, TypeScript cannot narrow the union
- If no `errorTypes` are provided, all errors are caught
- Unspecified error types are rethrown even when `errorTypes` is provided
